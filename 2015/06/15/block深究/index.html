<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="å…³äºblockç½‘ä¸Šä¹Ÿæ˜¯ä¸€å¤§æŠŠçš„æ–‡ç« ï¼Œä½†æ€»è§‰å¾—æœ‰çš„è¯´çš„å¤ªæ·±æœ‰çš„è¯´çš„å¤ªæµ…ã€‚æœ€è¿‘çœ‹äº†ä¸€äº›blockçš„èµ„æ–™ï¼Œå¹¶åŠ¨æ‰‹åšäº†ä¸€äº›å®è·µï¼Œæ‘˜å½•å¹¶æ·»åŠ äº†ä¸€äº›ç»“è®ºã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Blockæ·±ç©¶">
<meta property="og:url" content="http://dupengfei.com/2015/06/15/blockæ·±ç©¶/index.html">
<meta property="og:site_name" content="æœé¹é£çš„åšå®¢">
<meta property="og:description" content="å…³äºblockç½‘ä¸Šä¹Ÿæ˜¯ä¸€å¤§æŠŠçš„æ–‡ç« ï¼Œä½†æ€»è§‰å¾—æœ‰çš„è¯´çš„å¤ªæ·±æœ‰çš„è¯´çš„å¤ªæµ…ã€‚æœ€è¿‘çœ‹äº†ä¸€äº›blockçš„èµ„æ–™ï¼Œå¹¶åŠ¨æ‰‹åšäº†ä¸€äº›å®è·µï¼Œæ‘˜å½•å¹¶æ·»åŠ äº†ä¸€äº›ç»“è®ºã€‚">
<meta property="og:updated_time" content="2017-03-16T12:11:28.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Blockæ·±ç©¶">
<meta name="twitter:description" content="å…³äºblockç½‘ä¸Šä¹Ÿæ˜¯ä¸€å¤§æŠŠçš„æ–‡ç« ï¼Œä½†æ€»è§‰å¾—æœ‰çš„è¯´çš„å¤ªæ·±æœ‰çš„è¯´çš„å¤ªæµ…ã€‚æœ€è¿‘çœ‹äº†ä¸€äº›blockçš„èµ„æ–™ï¼Œå¹¶åŠ¨æ‰‹åšäº†ä¸€äº›å®è·µï¼Œæ‘˜å½•å¹¶æ·»åŠ äº†ä¸€äº›ç»“è®ºã€‚">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://dupengfei.com/2015/06/15/blockæ·±ç©¶/"/>





  <title> Blockæ·±ç©¶ | æœé¹é£çš„åšå®¢ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?b627bfa0d9d39ca04a7102b636415274";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœé¹é£çš„åšå®¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">è®°å½•ä¸€äº›ï¼Œåˆ†äº«ä¸€äº›ï¼Œæ¬¢è¿äº¤æµ ğŸ˜</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://dupengfei.com/2015/06/15/blockæ·±ç©¶/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="æœé¹é£">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœé¹é£çš„åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Blockæ·±ç©¶
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2015-06-15T18:32:11+08:00">
                2015-06-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/06/15/blockæ·±ç©¶/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/06/15/blockæ·±ç©¶/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <!--
## ç›®å½•

*   ##### ä»€ä¹ˆæ˜¯blockï¼Ÿ

    *   blockç¼–è¯‘è½¬æ¢ç»“æ„
    *   blockå®é™…ç»“æ„

*   ##### blockçš„ç±»å‹

    *   NSConcreteGlobalBlockå’ŒNSConcreteStackBlock
    *   NSConcreteMallocBlock

*   ##### æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“

    *   å±€éƒ¨å˜é‡
    *   å…¨å±€å˜é‡
    *   å±€éƒ¨é™æ€å˜é‡
    *   __blockä¿®é¥°çš„å˜é‡
    *   selféšå¼å¾ªç¯å¼•ç”¨

*   ##### ä¸åŒç±»å‹blockçš„å¤åˆ¶

    *   æ ˆblock
    *   å †block
    *   å…¨å±€block

*   ##### blockè¾…åŠ©å‡½æ•°

    *   __blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°
    *   å¯¹è±¡çš„è¾…åŠ©å‡½æ•°

*   ##### ARCä¸­blockçš„å·¥ä½œ

    *   blockè¯•éªŒ
    *   blockä½œä¸ºå‚æ•°ä¼ é€’
    *   blockä½œä¸ºè¿”å›å€¼
    *   blockå±æ€§

### å‚è€ƒåšæ–‡-->
<p>å…³äºblockç½‘ä¸Šä¹Ÿæ˜¯ä¸€å¤§æŠŠçš„æ–‡ç« ï¼Œä½†æ€»è§‰å¾—æœ‰çš„è¯´çš„å¤ªæ·±æœ‰çš„è¯´çš„å¤ªæµ…ã€‚æœ€è¿‘çœ‹äº†ä¸€äº›blockçš„èµ„æ–™ï¼Œå¹¶åŠ¨æ‰‹åšäº†ä¸€äº›å®è·µï¼Œæ‘˜å½•å¹¶æ·»åŠ äº†ä¸€äº›ç»“è®ºã€‚</p>
<a id="more"></a>
<h2 id="ä»€ä¹ˆæ˜¯blockï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯blockï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯blockï¼Ÿ"></a>ä»€ä¹ˆæ˜¯blockï¼Ÿ</h2><p>é¦–å…ˆï¼Œçœ‹ä¸€ä¸ªæç®€çš„blockï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">       @autoreleasepool &#123;</div><div class="line"></div><div class="line">           ^&#123; &#125;;</div><div class="line">       &#125;</div><div class="line">       return 0;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="blockç¼–è¯‘è½¬æ¢ç»“æ„"><a href="#blockç¼–è¯‘è½¬æ¢ç»“æ„" class="headerlink" title="blockç¼–è¯‘è½¬æ¢ç»“æ„"></a>blockç¼–è¯‘è½¬æ¢ç»“æ„</h3><p>å¯¹å…¶æ‰§è¡Œclang -rewrite-objcç¼–è¯‘è½¬æ¢æˆC++å®ç°ï¼Œå¾—åˆ°ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">struct __block_impl &#123;</div><div class="line">     void *isa;</div><div class="line">     int Flags;</div><div class="line">     int Reserved;</div><div class="line">     void *FuncPtr;</div><div class="line"> &#125;;</div><div class="line"></div><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">   struct __block_impl impl;</div><div class="line">   struct __main_block_desc_0* Desc;</div><div class="line">   __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">     impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">     impl.Flags = flags;</div><div class="line">     impl.FuncPtr = fp;</div><div class="line">     Desc = desc;</div><div class="line">   &#125;</div><div class="line"> &#125;;</div><div class="line"> static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> static struct __main_block_desc_0 &#123;</div><div class="line">   size_t reserved;</div><div class="line">   size_t Block_size;</div><div class="line"> &#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</div><div class="line"> int main(int argc, const char * argv[]) &#123;</div><div class="line">     /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool;</div><div class="line">         (void (*)())&amp;amp;__main_block_impl_0((void *)__main_block_func_0, &amp;amp;__main_block_desc_0_DATA);</div><div class="line">     &#125;</div><div class="line">     return 0;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>ä¸éš¾çœ‹å‡ºå…¶ä¸­çš„<strong>main_block_impl_0å°±æ˜¯blockçš„ä¸€ä¸ªC++çš„å®ç°(æœ€åé¢çš„_0ä»£è¡¨æ˜¯mainä¸­çš„ç¬¬å‡ ä¸ªblock)ï¼Œä¹Ÿå°±æ˜¯è¯´ä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“ã€‚<br>    å…¶ä¸­</strong>block_implçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">struct __block_impl &#123;</div><div class="line">  void *isa;</div><div class="line">  int Flags;</div><div class="line">  int Reserved;</div><div class="line">  void *FuncPtr;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ç»“æ„ä½“æˆå‘˜å¦‚ä¸‹ï¼š  </p>
<ul>
<li>isaï¼ŒæŒ‡å‘æ‰€å±ç±»çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯blockçš„ç±»å‹</li>
<li>flagsï¼Œæ ‡å¿—å˜é‡ï¼Œåœ¨å®ç°blockçš„å†…éƒ¨æ“ä½œæ—¶ä¼šç”¨åˆ°</li>
<li>Reservedï¼Œä¿ç•™å˜é‡</li>
<li>FuncPtrï¼Œblockæ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆ</li>
<li><p>å¯ä»¥çœ‹å‡ºï¼Œå®ƒåŒ…å«äº†isaæŒ‡é’ˆï¼ˆåŒ…å«isaæŒ‡é’ˆçš„çš†ä¸ºå¯¹è±¡ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´blockä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡* (runtimeé‡Œé¢ï¼Œå¯¹è±¡å’Œç±»éƒ½æ˜¯ç”¨ç»“æ„ä½“è¡¨ç¤º)ã€‚</p>
<p>__main_block_desc_0çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">    &#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</div></pre></td></tr></table></figure>
<p>å…¶ç»“æ„æˆå‘˜å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>reservedï¼šä¿ç•™å­—æ®µ</li>
<li>Block_sizeï¼šblockå¤§å°(sizeof(struct __main_block_impl_0))</li>
<li><p>ä»¥ä¸Šä»£ç åœ¨å®šä¹‰<strong>main_block_desc_0ç»“æ„ä½“æ—¶ï¼ŒåŒæ—¶åˆ›å»ºäº†</strong>main_block_desc_0_DATAï¼Œå¹¶ç»™å®ƒèµ‹å€¼ï¼Œä»¥ä¾›åœ¨mainå‡½æ•°ä¸­å¯¹__main_block_impl_0è¿›è¡Œåˆå§‹åŒ–ã€‚</p>
<p>__main_block_impl_0å®šä¹‰äº†æ˜¾å¼çš„æ„é€ å‡½æ•°ï¼Œå…¶å‡½æ•°ä½“å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">      impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">      impl.Flags = flags;</div><div class="line">      impl.FuncPtr = fp;</div><div class="line">      Desc = desc;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œ</p>
<ul>
<li>__main_block_impl_0çš„isaæŒ‡é’ˆæŒ‡å‘äº†_NSConcreteStackBlockï¼Œ</li>
<li>ä»mainå‡½æ•°ä¸­çœ‹ï¼Œ <strong>main_block_impl_0çš„FuncPtræŒ‡å‘äº†å‡½æ•°</strong>main_block_func_0</li>
<li><strong>main_block_impl_0çš„Descä¹ŸæŒ‡å‘äº†å®šä¹‰</strong>main_block_desc_0æ—¶å°±åˆ›å»ºçš„__main_block_desc_0_DATAï¼Œå…¶ä¸­çºªå½•äº†blockç»“æ„ä½“å¤§å°ç­‰ä¿¡æ¯ã€‚</li>
<li>ä»¥ä¸Šå°±æ˜¯æ ¹æ®ç¼–è¯‘è½¬æ¢çš„ç»“æœï¼Œå¯¹ä¸€ä¸ªç®€å•blockçš„è§£æï¼Œåé¢ä¼šå°†blockæ“ä½œä¸åŒç±»å‹çš„å¤–éƒ¨å˜é‡ï¼Œå¯¹blockç»“æ„çš„å½±å“è¿›è¡Œç›¸åº”çš„è¯´æ˜ã€‚</li>
</ul>
<h3 id="blockå®é™…ç»“æ„"><a href="#blockå®é™…ç»“æ„" class="headerlink" title="blockå®é™…ç»“æ„"></a>blockå®é™…ç»“æ„</h3><p>æ¥ä¸‹æ¥è§‚å¯Ÿä¸‹Block_private.hæ–‡ä»¶ä¸­å¯¹blockçš„ç›¸å…³ç»“æ„ä½“çš„çœŸå®å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/* Revised new layout. */</div><div class="line">    struct Block_descriptor &#123;</div><div class="line">        unsigned long int reserved;</div><div class="line">        unsigned long int size;</div><div class="line">        void (*copy)(void *dst, void *src);</div><div class="line">        void (*dispose)(void *);</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    struct Block_layout &#123;</div><div class="line">        void *isa;</div><div class="line">        int flags;</div><div class="line">        int reserved;</div><div class="line">        void (*invoke)(void *, ...);</div><div class="line">        struct Block_descriptor *descriptor;</div><div class="line">        /* Imported variables. */</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>æœ‰äº†ä¸Šæ–‡å¯¹ç¼–è¯‘è½¬æ¢çš„åˆ†æï¼Œè¿™é‡Œåªé’ˆå¯¹ç•¥å¾®ä¸åŒçš„æˆå‘˜è¿›è¡Œåˆ†æï¼š</p>
<p>invokeï¼ŒåŒä¸Šæ–‡çš„FuncPtrï¼Œblockæ‰§è¡Œæ—¶è°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆï¼Œblockå®šä¹‰æ—¶å†…éƒ¨çš„æ‰§è¡Œä»£ç éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­<br>Block_descriptorï¼Œblockçš„è¯¦ç»†æè¿°</p>
<ul>
<li>copy/disposeï¼Œè¾…åŠ©æ‹·è´/é”€æ¯å‡½æ•°ï¼Œå¤„ç†blockèŒƒå›´å¤–çš„å˜é‡æ—¶ä½¿ç”¨</li>
<li>æ€»ä½“æ¥è¯´ï¼Œblockå°±æ˜¯ä¸€ä¸ªé‡Œé¢å­˜å‚¨äº†æŒ‡å‘å‡½æ•°ä½“ä¸­åŒ…å«å®šä¹‰blockæ—¶çš„ä»£ç å—çš„å‡½æ•°æŒ‡é’ˆï¼Œä»¥åŠblockå¤–éƒ¨ä¸Šä¸‹æ–‡å˜é‡ç­‰ä¿¡æ¯çš„ç»“æ„ä½“ã€‚</li>
</ul>
<h2 id="blockçš„ç±»å‹"><a href="#blockçš„ç±»å‹" class="headerlink" title="blockçš„ç±»å‹"></a>blockçš„ç±»å‹</h2><p>blockçš„å¸¸è§ç±»å‹æœ‰3ç§ï¼š</p>
<p>   _NSConcreteGlobalBlockï¼ˆå…¨å±€ï¼‰<br>   _NSConcreteStackBlockï¼ˆæ ˆï¼‰<br>   _NSConcreteMallocBlockï¼ˆå †ï¼‰</p>
<ul>
<li>å…¶ä¸­å‰2ç§åœ¨Block.hç§å£°æ˜ï¼Œå1ç§åœ¨Block_private.hä¸­å£°æ˜ï¼Œæ‰€ä»¥æœ€å1ç§åŸºæœ¬ä¸ä¼šåœ¨æºç ä¸­å‡ºç°ã€‚</li>
<li>ç”±äºæ— æ³•ç›´æ¥åˆ›å»º_NSConcreteMallocBlockç±»å‹çš„blockï¼Œæ‰€ä»¥è¿™é‡Œåªå¯¹å‰é¢2ç§è¿›è¡Œæ‰‹åŠ¨åˆ›å»ºåˆ†æï¼Œæœ€å1ç§é€šè¿‡æºä»£ç åˆ†æã€‚</li>
</ul>
<h3 id="NSConcreteGlobalBlockå’ŒNSConcreteStackBlock"><a href="#NSConcreteGlobalBlockå’ŒNSConcreteStackBlock" class="headerlink" title="NSConcreteGlobalBlockå’ŒNSConcreteStackBlock"></a>NSConcreteGlobalBlockå’ŒNSConcreteStackBlock</h3><p>é¦–å…ˆï¼Œæ ¹æ®å‰é¢ä¸¤ç§ç±»å‹ï¼Œç¼–å†™ä»¥ä¸‹ä»£ç ï¼š </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">void (^globalBlock)() = ^&#123;</div><div class="line"></div><div class="line">        &#125;;</div><div class="line"></div><div class="line">   int main(int argc, const char * argv[]) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            void (^stackBlock1)() = ^&#123;</div><div class="line"></div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯¹å…¶è¿›è¡Œç¼–è¯‘è½¬æ¢åå¾—åˆ°ä»¥ä¸‹ç¼©ç•¥ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">// globalBlock</div><div class="line">    struct __globalBlock_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __globalBlock_block_desc_0* Desc;</div><div class="line">      __globalBlock_block_impl_0(void *fp, struct __globalBlock_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteGlobalBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    ...</div><div class="line"></div><div class="line">    // stackBlock</div><div class="line">    struct __main_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __main_block_desc_0* Desc;</div><div class="line">      __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    ...</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool;</div><div class="line">            void (*stackBlock)() = (void (*)())&amp;amp;__main_block_impl_0((void *)__main_block_func_0, &amp;amp;__main_block_desc_0_DATA);</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºglobalBlockçš„isaæŒ‡å‘äº†_NSConcreteGlobalBlockï¼Œå³åœ¨å…¨å±€åŒºåŸŸåˆ›å»ºï¼Œç¼–è¯‘æ—¶å…·ä½“çš„ä»£ç å°±å·²ç»ç¡®å®šåœ¨ä¸Šå›¾ä¸­çš„ä»£ç æ®µä¸­äº†ï¼Œblockå˜é‡å­˜å‚¨åœ¨å…¨å±€æ•°æ®å­˜å‚¨åŒºï¼›stackBlockçš„isaæŒ‡å‘äº†_NSConcreteStackBlockï¼Œå³åœ¨æ ˆåŒºåˆ›å»ºã€‚</p>
<h3 id="NSConcreteMallocBlock"><a href="#NSConcreteMallocBlock" class="headerlink" title="NSConcreteMallocBlock"></a>NSConcreteMallocBlock</h3><ul>
<li>æ¥ä¸‹æ¥æ˜¯åœ¨å †ä¸­çš„blockï¼Œå †ä¸­çš„blockæ— æ³•ç›´æ¥åˆ›å»ºï¼Œå…¶éœ€è¦ç”±_NSConcreteStackBlockç±»å‹çš„blockæ‹·è´è€Œæ¥(ä¹Ÿå°±æ˜¯è¯´blockéœ€è¦æ‰§è¡Œcopyä¹‹åæ‰èƒ½å­˜æ”¾åˆ°å †ä¸­)ã€‚ç”±äºblockçš„æ‹·è´æœ€ç»ˆéƒ½ä¼šè°ƒç”¨_Block_copy_internalå‡½æ•°ï¼Œæ‰€ä»¥è§‚å¯Ÿè¿™ä¸ªå‡½æ•°å°±å¯ä»¥çŸ¥é“å †ä¸­blockæ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„äº†ï¼š</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line">static void *_Block_copy_internal(const void *arg, const int flags) &#123;</div><div class="line">          struct Block_layout *aBlock;</div><div class="line">          ...</div><div class="line">          aBlock = (struct Block_layout *)arg;</div><div class="line">          ...</div><div class="line">          // Its a stack block.  Make a copy.</div><div class="line">          if (!isGC) &#123;</div><div class="line">              // ç”³è¯·blockçš„å †å†…å­˜</div><div class="line">              struct Block_layout *result = malloc(aBlock-&amp;gt;descriptor-&amp;gt;size);</div><div class="line">              if (!result) return (void *)0;</div><div class="line">              // æ‹·è´æ ˆä¸­blockåˆ°åˆšç”³è¯·çš„å †å†…å­˜ä¸­</div><div class="line">              memmove(result, aBlock, aBlock-&amp;gt;descriptor-&amp;gt;size); // bitcopy first</div><div class="line">              // reset refcount</div><div class="line">              result-&amp;gt;flags &amp;amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed</div><div class="line">              result-&amp;gt;flags |= BLOCK_NEEDS_FREE | 1;</div><div class="line">              // æ”¹å˜isaæŒ‡å‘_NSConcreteMallocBlockï¼Œå³å †blockç±»å‹</div><div class="line">              result-&amp;gt;isa = _NSConcreteMallocBlock;</div><div class="line">              if (result-&amp;gt;flags &amp;amp; BLOCK_HAS_COPY_DISPOSE) &#123;</div><div class="line">                  //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&amp;gt;descriptor-&amp;gt;copy, result, aBlock);</div><div class="line">                  (*aBlock-&amp;gt;descriptor-&amp;gt;copy)(result, aBlock); // do fixup</div><div class="line">              &#125;</div><div class="line">              return result;</div><div class="line">          &#125;</div><div class="line">          else &#123;</div><div class="line">              ...</div><div class="line">          &#125;</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>ä»ä»¥ä¸Šä»£ç ä»¥åŠæ³¨é‡Šå¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹å‡ºï¼Œå‡½æ•°é€šè¿‡memmoveå°†æ ˆä¸­çš„blockçš„å†…å®¹æ‹·è´åˆ°äº†å †ä¸­ï¼Œå¹¶ä½¿isaæŒ‡å‘äº†_NSConcreteMallocBlockã€‚<br>    blockä¸»è¦çš„ä¸€äº›å­¦é—®å°±å‡ºåœ¨æ ˆä¸­blockå‘å †ä¸­blockçš„è½¬ç§»è¿‡ç¨‹ä¸­äº†ã€‚</p>
<h2 id="æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“"><a href="#æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“" class="headerlink" title="æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“"></a>æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“</h2><p>æ¥ä¸‹æ¥ä¼šç¼–è¯‘è½¬æ¢æ•æ‰ä¸åŒå˜é‡ç±»å‹çš„blockï¼Œä»¥å¯¹æ¯”å®ƒä»¬çš„åŒºåˆ«ã€‚</p>
<h3 id="å±€éƒ¨å˜é‡"><a href="#å±€éƒ¨å˜é‡" class="headerlink" title="å±€éƒ¨å˜é‡"></a>å±€éƒ¨å˜é‡</h3><p>å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">- (void)test</div><div class="line">    &#123;</div><div class="line">        int a;</div><div class="line">        ^&#123;a;&#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">struct __Person__test_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __Person__test_block_desc_0* Desc;</div><div class="line">      int a;</div><div class="line">      // a(_a)æ˜¯æ„é€ å‡½æ•°çš„å‚æ•°åˆ—è¡¨åˆå§‹åŒ–å½¢å¼ï¼Œç›¸å½“äºa = _aã€‚ä»_I_Person_testçœ‹ï¼Œä¼ å…¥çš„å°±æ˜¯a</div><div class="line">      __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int _a, int flags=0) : a(_a) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line">      int a = __cself-&amp;gt;a; // bound by copy</div><div class="line">    a;&#125;</div><div class="line"></div><div class="line">    static struct __Person__test_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">    &#125; __Person__test_block_desc_0_DATA = &#123; 0, sizeof(struct __Person__test_block_impl_0)&#125;;</div><div class="line"></div><div class="line">    static void _I_Person_test(Person * self, SEL _cmd) &#123;</div><div class="line">        int a;</div><div class="line">        (void (*)())&amp;amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;amp;__Person__test_block_desc_0_DATA, a);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œblockç›¸å¯¹äºæ–‡ç« å¼€å¤´å¢åŠ äº†ä¸€ä¸ªintç±»å‹çš„æˆå‘˜å˜é‡ï¼Œä»–å°±æ˜¯ç”¨æ¥å­˜å‚¨å¤–éƒ¨å˜é‡açš„ã€‚å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡æ‹·è´åªæ˜¯ä¸€æ¬¡å€¼ä¼ é€’ã€‚å¹¶ä¸”å½“æˆ‘ä»¬æƒ³åœ¨blockä¸­è¿›è¡Œä»¥ä¸‹æ“ä½œæ—¶ï¼Œå°†ä¼šå‘ç”Ÿé”™è¯¯, å› ä¸º_I_Person_testå‡½æ•°ä¸­çš„aå’ŒPersontest_block_func_0å‡½æ•°ä¸­çš„aå¹¶æ²¡æœ‰åœ¨åŒä¸€ä¸ªä½œç”¨åŸŸï¼Œæ‰€ä»¥åœ¨blockå¯¹aè¿›è¡Œèµ‹å€¼æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ç»™å‡ºäº†é”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ°å€ä¼ é€’æ¥æ¶ˆé™¤ä»¥ä¸Šé”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (void)test</div><div class="line">    &#123;</div><div class="line">        int a = 0;</div><div class="line">        // åˆ©ç”¨æŒ‡é’ˆpå­˜å‚¨açš„åœ°å€</div><div class="line">        int *p = &amp;amp;a;</div><div class="line"></div><div class="line">        ^&#123;</div><div class="line">            // é€šè¿‡açš„åœ°å€è®¾ç½®açš„å€¼</div><div class="line">            *p = 10;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯å˜é‡açš„ç”Ÿå‘½å‘¨æœŸæ˜¯å’Œæ–¹æ³•testçš„æ ˆç›¸å…³è”çš„ï¼Œå½“testè¿è¡Œç»“æŸï¼Œæ ˆéšä¹‹é”€æ¯ï¼Œé‚£ä¹ˆå˜é‡aå°±ä¼šè¢«é”€æ¯ï¼Œpä¹Ÿå°±æˆä¸ºäº†é‡æŒ‡é’ˆã€‚å¦‚æœblockæ˜¯ä½œä¸ºå‚æ•°æˆ–è€…è¿”å›å€¼ï¼Œè¿™äº›ç±»å‹éƒ½æ˜¯è·¨æ ˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å†æ¬¡è°ƒç”¨ä¼šé€ æˆé‡æŒ‡é’ˆé”™è¯¯ã€‚</p>
<h3 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h3><p>å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// å…¨å±€é™æ€</div><div class="line">    static int a;</div><div class="line">    // å…¨å±€</div><div class="line">    int b;</div><div class="line">    - (void)test</div><div class="line">    &#123;</div><div class="line"></div><div class="line">        ^&#123;</div><div class="line">            a = 10;</div><div class="line">            b = 10;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">static int a;</div><div class="line">    int b;</div><div class="line"></div><div class="line">    struct __Person__test_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __Person__test_block_desc_0* Desc;</div><div class="line">      __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line"></div><div class="line">            a = 10;</div><div class="line">            b = 10;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    static struct __Person__test_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">    &#125; __Person__test_block_desc_0_DATA = &#123; 0, sizeof(struct __Person__test_block_impl_0)&#125;;</div><div class="line"></div><div class="line">    static void _I_Person_test(Person * self, SEL _cmd) &#123;</div><div class="line"></div><div class="line">        (void (*)())&amp;amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;amp;__Person__test_block_desc_0_DATA);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå› ä¸ºå…¨å±€å˜é‡éƒ½æ˜¯åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºï¼Œåœ¨ç¨‹åºç»“æŸå‰ä¸ä¼šè¢«é”€æ¯ï¼Œæ‰€ä»¥blockç›´æ¥è®¿é—®äº†å¯¹åº”çš„å˜é‡ï¼Œè€Œæ²¡æœ‰åœ¨Persontest_block_impl_0ç»“æ„ä½“ä¸­ç»™å˜é‡é¢„ç•™ä½ç½®ã€‚</p>
<h3 id="å±€éƒ¨é™æ€å˜é‡"><a href="#å±€éƒ¨é™æ€å˜é‡" class="headerlink" title="å±€éƒ¨é™æ€å˜é‡"></a>å±€éƒ¨é™æ€å˜é‡</h3><p>å‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)test</div><div class="line">    &#123;</div><div class="line">        static int a;</div><div class="line">        ^&#123;</div><div class="line">            a = 10;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">struct __Person__test_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __Person__test_block_desc_0* Desc;</div><div class="line">      int *a;</div><div class="line">      __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, int *_a, int flags=0) : a(_a) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line">      int *a = __cself-&amp;gt;a; // bound by copy</div><div class="line">            // è¿™é‡Œé€šè¿‡å±€éƒ¨é™æ€å˜é‡açš„åœ°å€æ¥å¯¹å…¶è¿›è¡Œä¿®æ”¹</div><div class="line">            (*a) = 10;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    static struct __Person__test_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">    &#125; __Person__test_block_desc_0_DATA = &#123; 0, sizeof(struct __Person__test_block_impl_0)&#125;;</div><div class="line"></div><div class="line">    static void _I_Person_test(Person * self, SEL _cmd) &#123;</div><div class="line">        static int a;</div><div class="line">        // ä¼ å…¥açš„åœ°å€</div><div class="line">        (void (*)())&amp;amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;amp;__Person__test_block_desc_0_DATA, &amp;amp;a);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯é™æ€å±€éƒ¨å˜é‡æ˜¯å­˜å‚¨åœ¨é™æ€æ•°æ®å­˜å‚¨åŒºåŸŸçš„ï¼Œä¹Ÿå°±æ˜¯å’Œç¨‹åºæ‹¥æœ‰ä¸€æ ·çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œéƒ½èƒ½å¤Ÿä¿è¯blockè®¿é—®åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„å˜é‡ã€‚ä½†æ˜¯å…¶ä½œç”¨èŒƒå›´è¿˜æ˜¯å±€é™äºå®šä¹‰å®ƒçš„å‡½æ•°ä¸­ï¼Œæ‰€ä»¥åªèƒ½åœ¨blocké€šè¿‡é™æ€å±€éƒ¨å˜é‡çš„åœ°å€æ¥è¿›è¡Œè®¿é—®ã€‚<br>å…³äºå˜é‡çš„å­˜å‚¨æˆ‘åŸæ¥çš„è¿™ç¯‡åšå®¢æœ‰æåŠï¼šcè¯­è¨€è‡†æƒ³&ndash;å…¨å±€&mdash;å±€éƒ¨å˜é‡</p>
<h3 id="blockä¿®é¥°çš„å˜é‡"><a href="#blockä¿®é¥°çš„å˜é‡" class="headerlink" title="__blockä¿®é¥°çš„å˜é‡"></a>__blockä¿®é¥°çš„å˜é‡</h3><p>å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)test</div><div class="line">    &#123;</div><div class="line">       __block int a;</div><div class="line">        ^&#123;</div><div class="line">            a = 10;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">struct __Block_byref_a_0 &#123;</div><div class="line">      void *__isa;</div><div class="line">    __Block_byref_a_0 *__forwarding;</div><div class="line">     int __flags;</div><div class="line">     int __size;</div><div class="line">     int a;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    struct __Person__test_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __Person__test_block_desc_0* Desc;</div><div class="line">      __Block_byref_a_0 *a; // by ref</div><div class="line">      __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&amp;gt;__forwarding) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line">      __Block_byref_a_0 *a = __cself-&amp;gt;a; // bound by ref</div><div class="line">            // æ³¨æ„ï¼Œè¿™é‡Œçš„_forwardingç”¨æ¥ä¿è¯æ“ä½œçš„å§‹ç»ˆæ˜¯å †ä¸­çš„æ‹·è´aï¼Œè€Œä¸æ˜¯æ ˆä¸­çš„a</div><div class="line">            (a-&amp;gt;__forwarding-&amp;gt;a) = 10;</div><div class="line">        &#125;</div><div class="line">    static void __Person__test_block_copy_0(struct __Person__test_block_impl_0*dst, struct __Person__test_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;amp;dst-&amp;gt;a, (void*)src-&amp;gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">    static void __Person__test_block_dispose_0(struct __Person__test_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&amp;gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">    static struct __Person__test_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">      void (*copy)(struct __Person__test_block_impl_0*, struct __Person__test_block_impl_0*);</div><div class="line">      void (*dispose)(struct __Person__test_block_impl_0*);</div><div class="line">    &#125; __Person__test_block_desc_0_DATA = &#123; 0, sizeof(struct __Person__test_block_impl_0), __Person__test_block_copy_0, __Person__test_block_dispose_0&#125;;</div><div class="line"></div><div class="line">    static void _I_Person_test(Person * self, SEL _cmd) &#123;</div><div class="line">        // __blockå°†aåŒ…è£…æˆäº†ä¸€ä¸ªå¯¹è±¡</div><div class="line">       __attribute__((__blocks__(byref))) __Block_byref_a_0 a = &#123;(void*)0,(__Block_byref_a_0 *)&amp;amp;a, 0, sizeof(__Block_byref_a_0)&#125;;</div><div class="line">    ;</div><div class="line">        (void (*)())&amp;amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;amp;__Person__test_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;amp;a, 570425344);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹æ¯”ä¸Šé¢çš„ç»“æœï¼Œæ˜æ˜¾å¤šäº†<strong>Block_byref_a_0ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“ä¸­å«æœ‰isaæŒ‡é’ˆï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯ç”¨æ¥åŒ…è£…å±€éƒ¨å˜é‡açš„ã€‚å½“blockè¢«copyåˆ°å †ä¸­æ—¶ï¼Œ</strong>Person<strong>test_block_impl_0çš„æ‹·è´è¾…åŠ©å‡½æ•°</strong>Person<strong>test_block_copy_0ä¼šå°†</strong>Block_byref_a_0æ‹·è´è‡³å †ä¸­ï¼Œæ‰€ä»¥å³ä½¿å±€éƒ¨å˜é‡æ‰€åœ¨å †è¢«é”€æ¯ï¼Œblockä¾ç„¶èƒ½å¯¹å †ä¸­çš„å±€éƒ¨å˜é‡è¿›è¡Œæ“ä½œã€‚å…¶ä¸­<strong>Block_byref_a_0æˆå‘˜æŒ‡é’ˆ</strong>forwardingç”¨æ¥æŒ‡å‘å®ƒåœ¨å †ä¸­çš„æ‹·è´ï¼Œå…¶ä¾æ®æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) &#123;</div><div class="line">        struct Block_byref **destp = (struct Block_byref **)dest;</div><div class="line">        struct Block_byref *src = (struct Block_byref *)arg;</div><div class="line"></div><div class="line">        ...</div><div class="line">        // å †ä¸­æ‹·è´çš„forwardingæŒ‡å‘å®ƒè‡ªå·±</div><div class="line">        copy-&amp;gt;forwarding = copy; // patch heap copy to point to itself (skip write-barrier)</div><div class="line">        // æ ˆä¸­çš„forwardingæŒ‡å‘å †ä¸­çš„æ‹·è´</div><div class="line">        src-&amp;gt;forwarding = copy;  // patch stack to point to heap copy</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·åšæ˜¯ä¸ºäº†ä¿è¯æ“ä½œçš„å€¼å§‹ç»ˆæ˜¯å †ä¸­çš„æ‹·è´ï¼Œè€Œä¸æ˜¯æ ˆä¸­çš„å€¼ã€‚ï¼ˆå¤„ç†åœ¨å±€éƒ¨å˜é‡æ‰€åœ¨æ ˆè¿˜æ²¡é”€æ¯ï¼Œå°±è°ƒç”¨blockæ¥æ”¹å˜å±€éƒ¨å˜é‡å€¼çš„æƒ…å†µï¼Œå¦‚æœæ²¡æœ‰__forwardingæŒ‡é’ˆï¼Œåˆ™ä¿®æ”¹æ— æ•ˆï¼‰<br>    è‡³äºblockå¦‚ä½•å®ç°å¯¹å±€éƒ¨å˜é‡çš„æ‹·è´ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜ã€‚</p>
<h3 id="selféšå¼å¾ªç¯å¼•ç”¨"><a href="#selféšå¼å¾ªç¯å¼•ç”¨" class="headerlink" title="selféšå¼å¾ªç¯å¼•ç”¨"></a>selféšå¼å¾ªç¯å¼•ç”¨</h3><p>å‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">@implementation Person</div><div class="line">    &#123;</div><div class="line">        int _a;</div><div class="line">        void (^_block)();</div><div class="line">    &#125;</div><div class="line">    - (void)test</div><div class="line">    &#123;</div><div class="line">      void (^_block)() = ^&#123;</div><div class="line">            _a = 10;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @end</div></pre></td></tr></table></figure>
<p>åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">struct __Person__test_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __Person__test_block_desc_0* Desc;</div><div class="line">      // å¯ä»¥çœ‹åˆ°ï¼Œblockå¼ºå¼•ç”¨äº†self</div><div class="line">      Person *self;</div><div class="line">      __Person__test_block_impl_0(void *fp, struct __Person__test_block_desc_0 *desc, Person *_self, int flags=0) : self(_self) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">    static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line">      Person *self = __cself-&amp;gt;self; // bound by copy</div><div class="line"></div><div class="line">            (*(int *)((char *)self + OBJC_IVAR_$_Person$_a)) = 10;</div><div class="line">        &#125;</div><div class="line">    static void __Person__test_block_copy_0(struct __Person__test_block_impl_0*dst, struct __Person__test_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;amp;dst-&amp;gt;self, (void*)src-&amp;gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">    static void __Person__test_block_dispose_0(struct __Person__test_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&amp;gt;self, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">    static struct __Person__test_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">      void (*copy)(struct __Person__test_block_impl_0*, struct __Person__test_block_impl_0*);</div><div class="line">      void (*dispose)(struct __Person__test_block_impl_0*);</div><div class="line">    &#125; __Person__test_block_desc_0_DATA = &#123; 0, sizeof(struct __Person__test_block_impl_0), __Person__test_block_copy_0, __Person__test_block_dispose_0&#125;;</div><div class="line"></div><div class="line">    static void _I_Person_test(Person * self, SEL _cmd) &#123;</div><div class="line">      void (*_block)() = (void (*)())&amp;amp;__Person__test_block_impl_0((void *)__Person__test_block_func_0, &amp;amp;__Person__test_block_desc_0_DATA, self, 570425344);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœåœ¨ç¼–è¯‘è½¬æ¢å‰ï¼Œå°†_aæ”¹æˆself.aï¼Œèƒ½å¾ˆæ˜æ˜¾åœ°çœ‹å‡ºæ˜¯äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨(selfå¼ºå¼•ç”¨blockï¼Œblockå¼ºå¼•ç”¨self)ã€‚é‚£ä¹ˆä½¿ç”¨_aå‘¢ï¼Ÿç»è¿‡ç¼–è¯‘è½¬æ¢åï¼Œä¾ç„¶å¯ä»¥åœ¨<strong>Person</strong>test_block_impl_0çœ‹è§selfçš„èº«å½±ã€‚ä¸”åœ¨å‡½æ•°_I_Person_testä¸­ï¼Œä¼ å…¥çš„å‚æ•°ä¹Ÿæ˜¯selfã€‚é€šè¿‡ä»¥ä¸‹è¯­å¥ï¼Œå¯ä»¥çœ‹å‡ºï¼Œä¸ç®¡æ˜¯ç”¨ä»€ä¹ˆå½¢å¼è®¿é—®å®ä¾‹å˜é‡ï¼Œæœ€ç»ˆéƒ½ä¼šè½¬æ¢æˆself+å˜é‡å†…å­˜åç§»çš„å½¢å¼ã€‚æ‰€ä»¥åœ¨ä¸Šé¢ä¾‹å­ä¸­ä½¿ç”¨_aä¹Ÿä¼šé€ æˆå¾ªç¯å¼•ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) &#123;</div><div class="line">      Person *self = __cself-&amp;gt;self; // bound by copy</div><div class="line">            // selfï¼‹å®ä¾‹å˜é‡açš„åç§»å€¼</div><div class="line">            (*(int *)((char *)self + OBJC_IVAR_$_Person$_a)) = 10;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h2 id="ä¸åŒç±»å‹blockçš„å¤åˆ¶"><a href="#ä¸åŒç±»å‹blockçš„å¤åˆ¶" class="headerlink" title="ä¸åŒç±»å‹blockçš„å¤åˆ¶"></a>ä¸åŒç±»å‹blockçš„å¤åˆ¶</h2><p>blockçš„å¤åˆ¶ä»£ç åœ¨_Block_copy_internalå‡½æ•°ä¸­ã€‚</p>
<h3 id="æ ˆblock"><a href="#æ ˆblock" class="headerlink" title="æ ˆblock"></a>æ ˆblock</h3><p>ä»ä»¥ä¸‹ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ ˆblockçš„å¤åˆ¶ä¸ä»…ä»…å¤åˆ¶äº†å…¶å†…å®¹ï¼Œè¿˜æ·»åŠ äº†ä¸€äº›é¢å¤–çš„ä¸œè¥¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">* 1ã€å¾€flagsä¸­å¹¶å…¥äº†BLOCK_NEEDS_FREEï¼ˆè¿™ä¸ªæ ‡å¿—è¡¨æ˜blockéœ€è¦é‡Šæ”¾ï¼Œåœ¨releaseä»¥åŠå†æ¬¡æ‹·è´æ—¶ä¼šç”¨åˆ°ï¼‰</div><div class="line"></div><div class="line">    * 2ã€å¦‚æœæœ‰è¾…åŠ©copyå‡½æ•°ï¼ˆBLOCK_HAS_COPY_DISPOSEï¼‰ï¼Œé‚£ä¹ˆå°±è°ƒç”¨ï¼ˆè¿™ä¸ªè¾…åŠ©copyå‡½æ•°æ˜¯ç”¨æ¥æ‹·è´blockæ•è·çš„å˜é‡çš„ï¼‰</div><div class="line"></div><div class="line">    struct Block_layout *result = malloc(aBlock-&amp;gt;descriptor-&amp;gt;size);</div><div class="line">    if (!result) return (void *)0;</div><div class="line">      memmove(result, aBlock, aBlock-&amp;gt;descriptor-&amp;gt;size); // bitcopy first</div><div class="line">    // reset refcount</div><div class="line">    result-&amp;gt;flags &amp;amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed</div><div class="line">    result-&amp;gt;flags |= BLOCK_NEEDS_FREE | 1;</div><div class="line">    result-&amp;gt;isa = _NSConcreteMallocBlock;</div><div class="line">    if (result-&amp;gt;flags &amp;amp; BLOCK_HAS_COPY_DISPOSE) &#123;</div><div class="line">          //printf(&quot;calling block copy helper %p(%p, %p)...\n&quot;, aBlock-&amp;gt;descriptor-&amp;gt;copy, result, aBlock);</div><div class="line">          (*aBlock-&amp;gt;descriptor-&amp;gt;copy)(result, aBlock); // do fixup</div><div class="line">      &#125;</div><div class="line">      return result;</div></pre></td></tr></table></figure>
<h3 id="å †block"><a href="#å †block" class="headerlink" title="å †block"></a>å †block</h3><p>ä»ä»¥ä¸‹ä»£ç çœ‹å‡ºï¼Œå¦‚æœblockçš„flagsä¸­æœ‰BLOCK_NEEDS_FREEæ ‡å¿—ï¼ˆblockä»æ ˆä¸­æ‹·è´åˆ°å †æ—¶æ·»åŠ çš„æ ‡å¿—ï¼‰ï¼Œå°±æ‰§è¡Œlatching_incr_intæ“ä½œï¼Œå…¶åŠŸèƒ½å°±æ˜¯è®©blockçš„å¼•ç”¨è®¡æ•°åŠ 1ã€‚æ‰€ä»¥å †ä¸­blockçš„æ‹·è´åªæ˜¯å•çº¯åœ°æ”¹å˜äº†å¼•ç”¨è®¡æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">    if (aBlock-&amp;gt;flags &amp;amp; BLOCK_NEEDS_FREE) &#123;</div><div class="line">          // latches on high</div><div class="line">          latching_incr_int(&amp;amp;aBlock-&amp;gt;flags);</div><div class="line">          return aBlock;</div><div class="line">      &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<h3 id="å…¨å±€block"><a href="#å…¨å±€block" class="headerlink" title="å…¨å±€block"></a>å…¨å±€block</h3><p>ä»ä»¥ä¸‹ä»£ç çœ‹å‡ºï¼Œå¯¹äºå…¨å±€blockï¼Œå‡½æ•°æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œç›´æ¥è¿”å›äº†ä¼ å…¥çš„block</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">else if (aBlock-&amp;gt;flags &amp;amp; BLOCK_IS_GLOBAL) &#123;</div><div class="line">          return aBlock;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="blockè¾…åŠ©å‡½æ•°"><a href="#blockè¾…åŠ©å‡½æ•°" class="headerlink" title="blockè¾…åŠ©å‡½æ•°"></a>blockè¾…åŠ©å‡½æ•°</h2><ul>
<li>ä¸Šæ–‡æåŠåˆ°äº†blockè¾…åŠ©copyä¸disposeå¤„ç†å‡½æ•°ï¼Œè¿™é‡Œåˆ†æä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„å†…éƒ¨å®ç°ã€‚åœ¨æ•* è·å˜é‡ä¸º__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹ï¼Œæˆ–è€…ä¸ºå¯¹è±¡æ—¶ï¼Œblockæ‰ä¼šæœ‰è¿™ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ã€‚</li>
<li>blockæ•æ‰å˜é‡æ‹·è´å‡½æ•°ä¸º_Block_object_assignã€‚åœ¨è°ƒç”¨å¤åˆ¶blockçš„å‡½æ•°_Block_copy_internalæ—¶ï¼Œä¼šæ ¹æ®blockæœ‰æ— è¾…åŠ©å‡½æ•°æ¥å¯¹æ•æ‰å˜é‡æ‹·è´å‡½æ•°_Block_object_assignè¿›è¡Œè°ƒç”¨ã€‚è€Œåœ¨_Block_object_assignå‡½æ•°ä¸­ï¼Œä¹Ÿä¼šåˆ¤æ–­æ•æ‰å˜é‡åŒ…è£…è€Œæˆçš„å¯¹è±¡(Block_byrefç»“æ„ä½“)æ˜¯å¦æœ‰è¾…åŠ©å‡½æ•°ï¼Œæ¥è¿›è¡Œè°ƒç”¨ã€‚</li>
</ul>
<h3 id="blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°"><a href="#blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°" class="headerlink" title="__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°"></a>__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°</h3><p>ç¼–å†™ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">typedef void(^Block)();</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            __block int a;</div><div class="line">            Block block = ^ &#123;</div><div class="line">                a;</div><div class="line">            &#125;;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è½¬æ¢æˆC++ä»£ç åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">typedef void(*Block)();</div><div class="line">    // __block int a</div><div class="line">    struct __Block_byref_a_0 &#123;</div><div class="line">      void *__isa;</div><div class="line">    __Block_byref_a_0 *__forwarding;</div><div class="line">     int __flags;</div><div class="line">     int __size;</div><div class="line">     int a;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // block</div><div class="line">    struct __main_block_impl_0 &#123;</div><div class="line">      struct __block_impl impl;</div><div class="line">      struct __main_block_desc_0* Desc;</div><div class="line">      __Block_byref_a_0 *a; // by ref</div><div class="line">      __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_a_0 *_a, int flags=0) : a(_a-&amp;gt;__forwarding) &#123;</div><div class="line">        impl.isa = &amp;amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // blockå‡½æ•°ä½“</div><div class="line">    static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">      __Block_byref_a_0 *a = __cself-&amp;gt;a; // bound by ref</div><div class="line"></div><div class="line">                (a-&amp;gt;__forwarding-&amp;gt;a);</div><div class="line">            &#125;</div><div class="line">    // è¾…åŠ©copyå‡½æ•°</div><div class="line">    static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;amp;dst-&amp;gt;a, (void*)src-&amp;gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">    // è¾…åŠ©disposeå‡½æ•°</div><div class="line">    static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&amp;gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">    static struct __main_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">      void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</div><div class="line">      void (*dispose)(struct __main_block_impl_0*);</div><div class="line">    &#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool;</div><div class="line">            // è¿™é‡Œåˆ›å»ºäº†ï¼Œå¹¶å°†açš„flagsè®¾ç½®ä¸º0</div><div class="line">            __attribute__((__blocks__(byref))) __Block_byref_a_0 a = &#123;(void*)0,(__Block_byref_a_0 *)&amp;amp;a, 0, sizeof(__Block_byref_a_0)&#125;;</div><div class="line">    ;</div><div class="line">            Block block = (void (*)())&amp;amp;__main_block_impl_0((void *)__main_block_func_0, &amp;amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;amp;a, 570425344);</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢ä»£ç ä¸­ï¼Œè¢«<strong>blockä¿®é¥°çš„aå˜é‡å˜ä¸ºäº†</strong>Block_byref_a_0ç±»å‹ï¼Œæ ¹æ®è¿™ä¸ªæ ¼å¼ï¼Œä»æºç ä¸­æŸ¥çœ‹å¾—åˆ°ç›¸ä¼¼çš„å®šä¹‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">struct Block_byref &#123;</div><div class="line">        void *isa;</div><div class="line">        struct Block_byref *forwarding;</div><div class="line">        int flags; /* refcount; */</div><div class="line">        int size;</div><div class="line">        void (*byref_keep)(struct Block_byref *dst, struct Block_byref *src);</div><div class="line">        void (*byref_destroy)(struct Block_byref *);</div><div class="line">        /* long shared[0]; */</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // åšä¸‹å¯¹æ¯”</div><div class="line">    struct __Block_byref_a_0 &#123;</div><div class="line">      void *__isa;</div><div class="line">    __Block_byref_a_0 *__forwarding;</div><div class="line">     int __flags;</div><div class="line">     int __size;</div><div class="line">     int a;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // flags/_flagsç±»å‹</div><div class="line">    enum &#123;</div><div class="line">            /* See function implementation for a more complete description of these fields and combinations */</div><div class="line">            // æ˜¯ä¸€ä¸ªå¯¹è±¡</div><div class="line">            BLOCK_FIELD_IS_OBJECT   =  3,  /* id, NSObject, __attribute__((NSObject)), block, ... */</div><div class="line">            // æ˜¯ä¸€ä¸ªblock</div><div class="line">            BLOCK_FIELD_IS_BLOCK    =  7,  /* a block variable */</div><div class="line">            // è¢«__blockä¿®é¥°çš„å˜é‡</div><div class="line">            BLOCK_FIELD_IS_BYREF    =  8,  /* the on stack structure holding the __block variable */</div><div class="line">            // è¢«__weakä¿®é¥°çš„å˜é‡ï¼Œåªèƒ½è¢«è¾…åŠ©copyå‡½æ•°ä½¿ç”¨</div><div class="line">            BLOCK_FIELD_IS_WEAK     = 16,  /* declared __weak, only used in byref copy helpers */</div><div class="line">            // blockè¾…åŠ©å‡½æ•°è°ƒç”¨ï¼ˆå‘Šè¯‰å†…éƒ¨å®ç°ä¸è¦è¿›è¡Œretainæˆ–è€…copyï¼‰</div><div class="line">            BLOCK_BYREF_CALLER      = 128  /* called from __block (byref) copy/dispose support routines. */</div><div class="line">        &#125;;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œ__blockå°†åŸæ¥çš„åŸºæœ¬ç±»å‹åŒ…è£…æˆäº†å¯¹è±¡ã€‚å› ä¸ºä»¥ä¸Šä¸¤ä¸ªç»“æ„ä½“çš„å‰4ä¸ªæˆå‘˜çš„ç±»å‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå†…å­˜ç©ºé—´æ’åˆ—ä¸€è‡´ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">// è½¬æ¢æˆC++ä»£ç </div><div class="line">    static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;amp;dst-&amp;gt;a, (void*)src-&amp;gt;a, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">    // _Block_object_assignæºç </div><div class="line">    void _Block_object_assign(void *destAddr, const void *object, const int flags) &#123;</div><div class="line">    ...</div><div class="line">        else if ((flags &amp;amp; BLOCK_FIELD_IS_BYREF) == BLOCK_FIELD_IS_BYREF)  &#123;</div><div class="line">            // copying a __block reference from the stack Block to the heap</div><div class="line">            // flags will indicate if it holds a __weak reference and needs a special isa</div><div class="line">            _Block_byref_assign_copy(destAddr, object, flags);</div><div class="line">        &#125;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // _Block_byref_assign_copyæºç </div><div class="line">    static void _Block_byref_assign_copy(void *dest, const void *arg, const int flags) &#123;</div><div class="line">        // è¿™é‡Œå› ä¸ºå‰é¢4ä¸ªæˆå‘˜çš„å†…å­˜åˆ†å¸ƒä¸€æ ·ï¼Œæ‰€ä»¥ç›´æ¥è½¬æ¢åï¼Œä½¿ç”¨Block_byrefçš„æˆå‘˜å˜é‡åï¼Œèƒ½è®¿é—®åˆ°__Block_byref_a_0çš„å‰é¢4ä¸ªæˆå‘˜</div><div class="line">        struct Block_byref **destp = (struct Block_byref **)dest;</div><div class="line">        struct Block_byref *src = (struct Block_byref *)arg;</div><div class="line">    ...</div><div class="line">        else if ((src-&amp;gt;forwarding-&amp;gt;flags &amp;amp; BLOCK_REFCOUNT_MASK) == 0) &#123;</div><div class="line">            // ä»mainå‡½æ•°å¯¹__Block_byref_a_0çš„åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹åŒ–æ—¶å°†flagsèµ‹å€¼ä¸º0</div><div class="line">            // è¿™é‡Œè¡¨ç¤ºç¬¬ä¸€æ¬¡æ‹·è´ï¼Œä¼šè¿›è¡Œå¤åˆ¶æ“ä½œï¼Œå¹¶ä¿®æ”¹åŸæ¥flagsçš„å€¼</div><div class="line">            // static int _Byref_flag_initial_value = BLOCK_NEEDS_FREE | 2;</div><div class="line">            // å¯ä»¥çœ‹å‡ºï¼Œå¤åˆ¶åï¼Œä¼šå¹¶å…¥BLOCK_NEEDS_FREEï¼Œåé¢çš„2æ˜¯blockçš„åˆå§‹å¼•ç”¨è®¡æ•°</div><div class="line">            ...</div><div class="line">            copy-&amp;gt;flags = src-&amp;gt;flags | _Byref_flag_initial_value;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        // å·²ç»æ‹·è´åˆ°å †äº†ï¼Œåªå¢åŠ å¼•ç”¨è®¡æ•°</div><div class="line">        else if ((src-&amp;gt;forwarding-&amp;gt;flags &amp;amp; BLOCK_NEEDS_FREE) == BLOCK_NEEDS_FREE) &#123;</div><div class="line">            latching_incr_int(&amp;amp;src-&amp;gt;forwarding-&amp;gt;flags);</div><div class="line">        &#125;</div><div class="line">        // æ™®é€šçš„èµ‹å€¼ï¼Œé‡Œé¢æœ€åº•å±‚å°±*destptr = value;è¿™å¥è¡¨è¾¾å¼</div><div class="line">        _Block_assign(src-&amp;gt;forwarding, (void **)destp);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦æ“ä½œéƒ½åœ¨ä»£ç æ³¨é‡Šä¸­äº†ï¼Œæ€»ä½“æ¥è¯´ï¼Œ__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹ä¼šè¢«åŒ…è£…ä¸ºå¯¹è±¡ï¼Œå¹¶ä¸”åªåœ¨æœ€åˆblockæ‹·è´æ—¶å¤åˆ¶ä¸€æ¬¡ï¼Œåé¢çš„æ‹·è´åªä¼šå¢åŠ è¿™ä¸ªæ•è·å˜é‡çš„å¼•ç”¨è®¡æ•°ã€‚</p>
<h3 id="å¯¹è±¡çš„è¾…åŠ©å‡½æ•°"><a href="#å¯¹è±¡çš„è¾…åŠ©å‡½æ•°" class="headerlink" title="å¯¹è±¡çš„è¾…åŠ©å‡½æ•°"></a>å¯¹è±¡çš„è¾…åŠ©å‡½æ•°</h3><p>æ²¡æœ‰__blockä¿®é¥°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">typedef void(^Block)();</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            NSObject *a = [[NSObject alloc] init];</div><div class="line">            Block block = ^ &#123;</div><div class="line">                a;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œåœ¨æ²¡æœ‰__blockä¿®é¥°æ—¶ï¼Œå¯¹è±¡ç¼–è¯‘è½¬æ¢çš„ç»“æœå¦‚ä¸‹ï¼Œåˆ é™¤äº†ä¸€äº›å˜åŒ–ä¸å¤§çš„ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">      NSObject *a = __cself-&amp;gt;a; // bound by copy</div><div class="line">                a;</div><div class="line">            &#125;</div><div class="line">    static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;amp;dst-&amp;gt;a, (void*)src-&amp;gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">    static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&amp;gt;a, 3/*BLOCK_FIELD_IS_OBJECT*/);&#125;</div><div class="line"></div><div class="line">    static struct __main_block_desc_0 &#123;</div><div class="line">      size_t reserved;</div><div class="line">      size_t Block_size;</div><div class="line">      void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</div><div class="line">      void (*dispose)(struct __main_block_impl_0*);</div><div class="line">    &#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0),</div></pre></td></tr></table></figure>
<p>å¯¹è±¡åœ¨æ²¡æœ‰<strong>blockä¿®é¥°æ—¶ï¼Œå¹¶æ²¡æœ‰äº§ç”Ÿ</strong>Block_byref_a_0ç»“æ„ä½“ï¼Œåªæ˜¯å°†æ ‡å¿—ä½ä¿®æ”¹ä¸ºBLOCK_FIELD_IS_OBJECTã€‚è€Œåœ¨_Block_object_assignä¸­å¯¹åº”çš„åˆ¤æ–­åˆ†æ”¯ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">else if ((flags &amp;amp; BLOCK_FIELD_IS_OBJECT) == BLOCK_FIELD_IS_OBJECT) &#123;</div><div class="line">        _Block_retain_object(object);</div><div class="line">        _Block_assign((void *)object, destAddr);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œblockå¤åˆ¶æ—¶ï¼Œä¼šretainæ•æ‰å¯¹è±¡ï¼Œä»¥å¢åŠ å…¶å¼•ç”¨è®¡æ•°ã€‚</p>
<p>æœ‰__blockä¿®é¥°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">typedef void(^Block)();</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            __block NSObject *a = [[NSObject alloc] init];</div><div class="line">            Block block = ^ &#123;</div><div class="line">                a;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘è½¬æ¢çš„éƒ¨åˆ†ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">struct __Block_byref_a_0 &#123;</div><div class="line">      void *__isa;</div><div class="line">    __Block_byref_a_0 *__forwarding;</div><div class="line">     int __flags;</div><div class="line">     int __size;</div><div class="line">     void (*__Block_byref_id_object_copy)(void*, void*);</div><div class="line">     void (*__Block_byref_id_object_dispose)(void*);</div><div class="line">     NSObject *a;</div><div class="line">    &#125;;</div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool;</div><div class="line">    attribute__((__blocks__(byref))) __Block_byref_a_0 a = &#123;(void*)0,(__Block_byref_a_0 *)&amp;amp;a, 33554432, sizeof(__Block_byref_a_0), __Block_byref_id_object_copy_131, __Block_byref_id_object_dispose_131,....&#125;;</div><div class="line">    Block block = (void (*)())&amp;amp;__main_block_impl_0((void *)__main_block_func_0, &amp;amp;__main_block_desc_0_DATA, (__Block_byref_a_0 *)&amp;amp;a, 570425344);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // ä»¥ä¸‹çš„40è¡¨ç¤º__Block_byref_a_0å¯¹è±¡açš„ä½ç§»ï¼ˆ4ä¸ªæŒ‡é’ˆ(32å­—èŠ‚)ï¼‹2ä¸ªintå˜é‡(8å­—èŠ‚)ï¼40å­—èŠ‚ï¼‰</div><div class="line">        static void __Block_byref_id_object_copy_131(void *dst, void *src) &#123;</div><div class="line">         _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);</div><div class="line">        &#125;</div><div class="line">        static void __Block_byref_id_object_dispose_131(void *src) &#123;</div><div class="line">         _Block_object_dispose(*(void * *) ((char*)src + 40), 131);</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<ol>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºå¯¹è±¡ï¼Œ<strong>Block_byref_a_0å¦å¤–å¢åŠ äº†ä¸¤ä¸ªè¾…åŠ©å‡½æ•°</strong>Block_byref_id_object_copyã€__Block_byref_id_object_dispose,ä»¥å®ç°å¯¹å¯¹è±¡</li>
<li>å†…å­˜çš„ç®¡ç†ã€‚å…¶ä¸­ä¸¤è€…çš„æœ€åä¸€ä¸ªå‚æ•°131è¡¨ç¤ºBLOCK_BYREF_CALLER|BLOCK_FIELD_IS_OBJECTï¼ŒBLOCK_BYREF_CALLERè¡¨ç¤ºåœ¨å†…éƒ¨å®ç°ä¸­ä¸å¯¹aå¯¹è±¡è¿›è¡Œretainæˆ–copyï¼›ä»¥ä¸‹ä¸ºç›¸å…³æºç </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if ((flags &amp;amp; BLOCK_BYREF_CALLER) == BLOCK_BYREF_CALLER) &#123;</div><div class="line">        ...</div><div class="line">        else &#123;</div><div class="line">            // do *not* retain or *copy* __block variables whatever they are</div><div class="line">            _Block_assign((void *)object, destAddr);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>_Block_byref_assign_copyå‡½æ•°çš„ä»¥ä¸‹ä»£ç ä¼šå¯¹ä¸Šé¢çš„è¾…åŠ©å‡½æ•°ï¼ˆ__Block_byref_id_object_copy_131ï¼‰è¿›è¡Œè°ƒç”¨ï¼›570425344è¡¨ç¤ºBLOCK_HAS_COPY_DISPOSE|BLOCK_HAS_DESCRIPTORï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œä»¥ä¸‹ç›¸å…³æºç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if (src-&amp;gt;flags &amp;amp; BLOCK_HAS_COPY_DISPOSE) &#123;</div><div class="line">        // Trust copy helper to copy everything of interest</div><div class="line">        // If more than one field shows up in a byref block this is wrong XXX</div><div class="line">        copy-&amp;gt;byref_keep = src-&amp;gt;byref_keep;</div><div class="line">        copy-&amp;gt;byref_destroy = src-&amp;gt;byref_destroy;</div><div class="line">        (*src-&amp;gt;byref_keep)(copy, src);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="ARCä¸­blockçš„å·¥ä½œ"><a href="#ARCä¸­blockçš„å·¥ä½œ" class="headerlink" title="ARCä¸­blockçš„å·¥ä½œ"></a>ARCä¸­blockçš„å·¥ä½œ</h2><p>è‹¹æœæ–‡æ¡£æåŠï¼Œåœ¨ARCæ¨¡å¼ä¸‹ï¼Œåœ¨æ ˆé—´ä¼ é€’blockæ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨copyæ ˆä¸­çš„blockï¼Œå³å¯è®©blockæ­£å¸¸å·¥ä½œã€‚ä¸»è¦åŸå› æ˜¯ARCå¯¹æ ˆä¸­çš„blockè‡ªåŠ¨æ‰§è¡Œäº†copyï¼Œå°†_NSConcreteStackBlockç±»å‹çš„blockè½¬æ¢æˆäº†_NSConcreteMallocBlockçš„blockã€‚</p>
<h3 id="blockè¯•éªŒ"><a href="#blockè¯•éªŒ" class="headerlink" title="blockè¯•éªŒ"></a>blockè¯•éªŒ</h3><p>ä¸‹é¢å¯¹blockåšç‚¹å®éªŒï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int i = 10;</div><div class="line">        void (^block)() = ^&#123;i;&#125;;</div><div class="line"></div><div class="line"> __weak void (^weakBlock)() = ^&#123;i;&#125;;</div><div class="line"></div><div class="line">    void (^stackBlock)() = ^&#123;&#125;;</div><div class="line"></div><div class="line">    // ARCæƒ…å†µä¸‹</div><div class="line"></div><div class="line">    // åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåœ¨æ ˆä¸­</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff730&amp;gt;</div><div class="line">    NSLog(@&quot;%@&quot;, ^&#123;i;&#125;);</div><div class="line"></div><div class="line">    // å› ä¸ºstackBlockä¸ºstrongç±»å‹ï¼Œä¸”æ•è·äº†å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥èµ‹å€¼æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œäº†copy</div><div class="line">    // &amp;lt;__NSMallocBlock__: 0x100206920&amp;gt;</div><div class="line">    NSLog(@&quot;%@&quot;, block);</div><div class="line"></div><div class="line">    // å¦‚æœæ˜¯weakç±»å‹çš„blockï¼Œä¾ç„¶ä¸ä¼šè‡ªåŠ¨è¿›è¡Œcopy</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff728&amp;gt;</div><div class="line">    NSLog(@&quot;%@&quot;, weakBlock);</div><div class="line"></div><div class="line">    // å¦‚æœblockæ˜¯strongç±»å‹ï¼Œå¹¶ä¸”æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šè½¬æ¢æˆ__NSGlobalBlock__</div><div class="line">    // &amp;lt;__NSGlobalBlock__: 0x100001110&amp;gt;</div><div class="line">    NSLog(@&quot;%@&quot;, stackBlock);</div><div class="line"></div><div class="line">    // åœ¨éARCæƒ…å†µä¸‹ï¼Œäº§ç”Ÿä»¥ä¸‹è¾“å‡º</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff6d0&amp;gt;</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff730&amp;gt;</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff700&amp;gt;</div><div class="line">    // &amp;lt;__NSGlobalBlock__: 0x1000010d0&amp;gt;</div><div class="line">&#125;</div><div class="line">return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼ŒARCå¯¹ç±»å‹ä¸ºstrongä¸”æ•è·äº†å¤–éƒ¨å˜é‡çš„blockè¿›è¡Œäº†copyã€‚å¹¶ä¸”å½“blockç±»å‹ä¸ºstrongï¼Œä½†æ˜¯åˆ›å»ºæ—¶æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œblockæœ€ç»ˆä¼šå˜æˆ<strong>NSGlobalBlock</strong>ç±»å‹ï¼ˆè¿™é‡Œå¯èƒ½å› ä¸ºblockä¸­çš„ä»£ç æ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨æ ˆä¸­å¼€è¾Ÿå˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¼–è¯‘æ—¶ï¼Œè¿™ä¸ªblockçš„æ‰€æœ‰å†…å®¹å·²ç»åœ¨ä»£ç æ®µä¸­ç”Ÿæˆäº†ï¼Œæ‰€ä»¥å°±æŠŠblockçš„ç±»å‹è½¬æ¢ä¸ºå…¨å±€ç±»å‹ï¼‰</p>
<h3 id="blockä½œä¸ºå‚æ•°ä¼ é€’"><a href="#blockä½œä¸ºå‚æ•°ä¼ é€’" class="headerlink" title="blockä½œä¸ºå‚æ•°ä¼ é€’"></a>blockä½œä¸ºå‚æ•°ä¼ é€’</h3><p>å†æ¥çœ‹ä¸‹ä½¿ç”¨åœ¨æ ˆä¸­çš„blockéœ€è¦æ³¨æ„çš„æƒ…å†µï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">NSMutableArray *arrayM;</div><div class="line">    void myBlock()</div><div class="line">    &#123;</div><div class="line">        int a = 5;</div><div class="line">        Block block = ^ &#123;</div><div class="line">            NSLog(@&quot;%d&quot;, a);</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        [arrayM addObject:block];</div><div class="line">        NSLog(@&quot;%@&quot;, block);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    int main(int argc, const char * argv[]) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            arrayM = @[].mutableCopy;</div><div class="line"></div><div class="line">            myBlock();</div><div class="line"></div><div class="line">            Block block = [arrayM firstObject];</div><div class="line">            // éARCè¿™é‡Œå´©æºƒ</div><div class="line">            block();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">    // ARCæƒ…å†µä¸‹è¾“å‡º</div><div class="line">    // &amp;lt;__NSMallocBlock__: 0x100214480&amp;gt;</div><div class="line"></div><div class="line">    // éARCæƒ…å†µä¸‹è¾“å‡º</div><div class="line">    // &amp;lt;__NSStackBlock__: 0x7fff5fbff738&amp;gt;</div><div class="line">    // å´©æºƒï¼Œé‡æŒ‡é’ˆé”™è¯¯</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒARCæƒ…å†µä¸‹å› ä¸ºè‡ªåŠ¨æ‰§è¡Œäº†copyï¼Œæ‰€ä»¥è¿”å›ç±»å‹ä¸º<strong>NSMallocBlock</strong>ï¼Œåœ¨å‡½æ•°ç»“æŸåä¾ç„¶å¯ä»¥è®¿é—®ï¼›è€ŒéARCæƒ…å†µä¸‹ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨[block copy]æ¥å°†blockæ‹·è´åˆ°å †ä¸­ï¼Œå¦åˆ™å› ä¸ºæ ˆä¸­çš„blockç”Ÿå‘½å‘¨æœŸå’Œå‡½æ•°ä¸­çš„æ ˆç”Ÿå‘½å‘¨æœŸå…³è”ï¼Œå½“å‡½æ•°é€€å‡ºåï¼Œç›¸åº”çš„å †è¢«é”€æ¯ï¼Œblockä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚<br>    å¦‚æœæŠŠblockçš„ä»¥ä¸‹ä»£ç åˆ é™¤ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSLog(@&quot;%d&quot;, a);</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆblockå°±ä¼šå˜æˆå…¨å±€ç±»å‹ï¼Œåœ¨mainä¸­è®¿é—®ä¹Ÿä¸ä¼šå‡ºå´©æºƒã€‚</p>
<h3 id="blockä½œä¸ºè¿”å›å€¼"><a href="#blockä½œä¸ºè¿”å›å€¼" class="headerlink" title="blockä½œä¸ºè¿”å›å€¼"></a>blockä½œä¸ºè¿”å›å€¼</h3><p>åœ¨éARCæƒ…å†µä¸‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯blockï¼Œåˆ™ä¸€èˆ¬è¿™æ ·æ“ä½œï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">return [[block copy] autorelease];</div></pre></td></tr></table></figure>
<p>å¯¹äºå¤–éƒ¨è¦ä½¿ç”¨çš„blockï¼Œæ›´è¶‹å‘äºæŠŠå®ƒæ‹·è´åˆ°å †ä¸­ï¼Œä½¿å…¶è„±ç¦»æ ˆç”Ÿå‘½å‘¨æœŸçš„çº¦æŸã€‚</p>
<h3 id="blockå±æ€§"><a href="#blockå±æ€§" class="headerlink" title="blockå±æ€§"></a>blockå±æ€§</h3><p>è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹å…³äºblockç±»å‹çš„ARCå±æ€§ã€‚ä¸Šæ–‡ä¹Ÿè¯´æ˜äº†ï¼ŒARCä¼šè‡ªåŠ¨å¸®strongç±»å‹ä¸”æ•è·å¤–éƒ¨å˜é‡çš„blockè¿›è¡Œcopyï¼Œæ‰€ä»¥åœ¨å®šä¹‰blockç±»å‹çš„å±æ€§æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨strongï¼Œä¸ä¸€å®šä½¿ç”¨copyã€‚ä¹Ÿå°±æ˜¯ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">/** å‡å¦‚æœ‰æ ˆblockèµ‹ç»™ä»¥ä¸‹ä¸¤ä¸ªå±æ€§ **/</div><div class="line"></div><div class="line">    // è¿™é‡Œå› ä¸ºARCï¼Œå½“æ ˆblockä¸­ä¼šæ•è·å¤–éƒ¨å˜é‡æ—¶ï¼Œè¿™ä¸ªblockä¼šè¢«copyè¿›å †ä¸­</div><div class="line">    // å¦‚æœæ²¡æœ‰æ•è·å¤–éƒ¨å˜é‡ï¼Œè¿™ä¸ªblockä¼šå˜ä¸ºå…¨å±€ç±»å‹</div><div class="line">    // ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå®ƒéƒ½è„±ç¦»äº†æ ˆç”Ÿå‘½å‘¨æœŸçš„çº¦æŸ</div><div class="line"></div><div class="line">    @property (strong, nonatomic) Block *strongBlock;</div><div class="line"></div><div class="line">    // è¿™é‡Œéƒ½ä¼šè¢«copyè¿›å †ä¸­</div><div class="line">    @property (copy, nonatomic) Block *copyBlock;</div></pre></td></tr></table></figure>
<h2 id="å‚è€ƒåšæ–‡"><a href="#å‚è€ƒåšæ–‡" class="headerlink" title="å‚è€ƒåšæ–‡"></a>å‚è€ƒåšæ–‡</h2><p>è°ˆObjective-C Blockçš„å®ç°(<a href="http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/" target="_blank" rel="external">http://blog.devtang.com/blog/2013/07/28/a-look-inside-blocks/</a>)<br>iOSä¸­blockå®ç°çš„æ¢ç©¶(<a href="http://blog.csdn.net/jasonblog/article/details/7756763" target="_blank" rel="external">http://blog.csdn.net/jasonblog/article/details/7756763</a>)<br>A look inside blocks: Episode 3<br>runtime.c<br>Block_private.h</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/03/13/å…³é”®è¯å¤‡å¿˜/" rel="next" title="å…³é”®è¯å¤‡å¿˜">
                <i class="fa fa-chevron-left"></i> å…³é”®è¯å¤‡å¿˜
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/08/20/HTTPç¬”è®°ï¼ˆä¸€ï¼‰/" rel="prev" title="HTTPç¬”è®°ï¼ˆä¸€ï¼‰">
                HTTPç¬”è®°ï¼ˆä¸€ï¼‰ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/06/15/blockæ·±ç©¶/"
           data-title="Blockæ·±ç©¶" data-url="http://dupengfei.com/2015/06/15/blockæ·±ç©¶/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="æœé¹é£" />
          <p class="site-author-name" itemprop="name">æœé¹é£</p>
           
              <p class="site-description motion-element" itemprop="description">ä¸€ä¸ªéå¸¸niceçš„iOSå¼€å‘ ğŸ˜„</p>
          
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/dupengfei" target="_blank" title="å¾®åš">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  å¾®åš
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://plus.google.com/u/0/117309292640302365524" target="_blank" title="G+">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  G+
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ä»€ä¹ˆæ˜¯blockï¼Ÿ"><span class="nav-number">1.</span> <span class="nav-text">ä»€ä¹ˆæ˜¯blockï¼Ÿ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#blockç¼–è¯‘è½¬æ¢ç»“æ„"><span class="nav-number">1.1.</span> <span class="nav-text">blockç¼–è¯‘è½¬æ¢ç»“æ„</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockå®é™…ç»“æ„"><span class="nav-number">1.2.</span> <span class="nav-text">blockå®é™…ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#blockçš„ç±»å‹"><span class="nav-number">2.</span> <span class="nav-text">blockçš„ç±»å‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSConcreteGlobalBlockå’ŒNSConcreteStackBlock"><span class="nav-number">2.1.</span> <span class="nav-text">NSConcreteGlobalBlockå’ŒNSConcreteStackBlock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSConcreteMallocBlock"><span class="nav-number">2.2.</span> <span class="nav-text">NSConcreteMallocBlock</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“"><span class="nav-number">3.</span> <span class="nav-text">æ•æ‰å˜é‡å¯¹blockç»“æ„çš„å½±å“</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å±€éƒ¨å˜é‡"><span class="nav-number">3.1.</span> <span class="nav-text">å±€éƒ¨å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¨å±€å˜é‡"><span class="nav-number">3.2.</span> <span class="nav-text">å…¨å±€å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å±€éƒ¨é™æ€å˜é‡"><span class="nav-number">3.3.</span> <span class="nav-text">å±€éƒ¨é™æ€å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockä¿®é¥°çš„å˜é‡"><span class="nav-number">3.4.</span> <span class="nav-text">__blockä¿®é¥°çš„å˜é‡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#selféšå¼å¾ªç¯å¼•ç”¨"><span class="nav-number">3.5.</span> <span class="nav-text">selféšå¼å¾ªç¯å¼•ç”¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¸åŒç±»å‹blockçš„å¤åˆ¶"><span class="nav-number">4.</span> <span class="nav-text">ä¸åŒç±»å‹blockçš„å¤åˆ¶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ ˆblock"><span class="nav-number">4.1.</span> <span class="nav-text">æ ˆblock</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å †block"><span class="nav-number">4.2.</span> <span class="nav-text">å †block</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å…¨å±€block"><span class="nav-number">4.3.</span> <span class="nav-text">å…¨å±€block</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#blockè¾…åŠ©å‡½æ•°"><span class="nav-number">5.</span> <span class="nav-text">blockè¾…åŠ©å‡½æ•°</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°"><span class="nav-number">5.1.</span> <span class="nav-text">__blockä¿®é¥°çš„åŸºæœ¬ç±»å‹çš„è¾…åŠ©å‡½æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¯¹è±¡çš„è¾…åŠ©å‡½æ•°"><span class="nav-number">5.2.</span> <span class="nav-text">å¯¹è±¡çš„è¾…åŠ©å‡½æ•°</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ARCä¸­blockçš„å·¥ä½œ"><span class="nav-number">6.</span> <span class="nav-text">ARCä¸­blockçš„å·¥ä½œ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#blockè¯•éªŒ"><span class="nav-number">6.1.</span> <span class="nav-text">blockè¯•éªŒ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockä½œä¸ºå‚æ•°ä¼ é€’"><span class="nav-number">6.2.</span> <span class="nav-text">blockä½œä¸ºå‚æ•°ä¼ é€’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockä½œä¸ºè¿”å›å€¼"><span class="nav-number">6.3.</span> <span class="nav-text">blockä½œä¸ºè¿”å›å€¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blockå±æ€§"><span class="nav-number">6.4.</span> <span class="nav-text">blockå±æ€§</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒåšæ–‡"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒåšæ–‡</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœé¹é£</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"dupengfei"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  













  
  

  

  

  

  


  

</body>
</html>
